require 'rubygems'
require 'rbbt/util/open'
require 'rbbt/util/rake'
require 'rbbt/sources/polysearch'
require 'rbbt/sources/pubmed'
require 'rbbt/sources/organism'

# Gene list is passed as global variable $genes. If not present, they are read from STDIN

desc "Load Pubmed IDs for genes in the list"
step(:pmids) do |t|

  if $genes.nil? 
    $genes = []
    STDIN.each_line{|l| $genes << l.chomp.strip}
  end

  pmids = Organism.gene_literature('human').values_at(*$genes).compact.flatten.uniq
  
  Open.write(t.name, pmids.join("\n"))
end

desc "Download article abstracts and merge into a meta-document"
step(:metadoc, :pmids) do |t|
  pmids = Open.read(t.prerequisites.first).split

  articles = PubMed.get_article(pmids)

  metadoc = articles.collect{|pmid, article|
    article.text
  }.join("\n")
 
  Open.write(t.name, metadoc)
end

desc "Find disease names in meta-document"
step(:diseases, :metadoc) do |t|
  metadoc = Open.read(t.prerequisites.first)

  disease_count = {}
  Polysearch.match(metadoc, ['disease']).values.flatten.each{|disease|
    disease_count[disease] ||= 0
    disease_count[disease] += 1
  }
  
  Open.write(t.name, disease_count.collect{|disease, count| "#{ disease }\t#{count}"}.join("\n"))
end

